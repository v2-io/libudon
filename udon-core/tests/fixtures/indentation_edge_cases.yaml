---
# Indentation edge cases - FULL-SPEC.md lines 543-639
#
# Key rules from SPEC:
# - SPEC 553: "pop while new_column <= stack_top.base_column"
# - SPEC 584-586: Greater column = child, Same column = sibling, Lesser = dedent
# - SPEC 588-589: "To be INSIDE an element, you must be at column > element's column"
#
# Single space is valid - column 1 > column 0 makes it a child.
# Mixed indent widths are valid as long as nesting follows column rules.

- id: single_space_indent_is_valid
  desc: Single space indent is valid (column 1 > column 0)
  udon: |-
    |a
     |b
  events:
    # |a at column 0
    # |b at column 1 - column 1 > 0 means |b is child of |a
    - ElementStart
    - [Name, "a"]
    - ElementStart
    - [Name, "b"]
    - ElementEnd
    - ElementEnd

- id: mixed_indent_levels_warns
  desc: Mixed indent levels warn (variable width siblings - poor form per SPEC 571-577)
  udon: |-
    |parent
      |child1
     |child2
  events:
    # |parent at column 0
    # |child1 at column 2 - child of parent, sets content_base = 2
    # |child2 at column 1 - still child of parent BUT warns (col 1 < content_base 2)
    # SPEC 571-577: "mixing them is confusing" = warn
    - ElementStart
    - [Name, "parent"]
    - ElementStart
    - [Name, "child1"]
    - ElementEnd
    - [Warning, "Inconsistent indentation"]
    - ElementStart
    - [Name, "child2"]
    - ElementEnd
    - ElementEnd

- id: element_with_only_attributes_then_sibling
  desc: Element with only attributes then sibling at column 0
  udon: |-
    |a
      :attr value
    |b
  events:
    # |a at column 0 with block attribute
    # |b at column 0 - same as |a, so sibling
    - ElementStart
    - [Name, "a"]
    - [Attr, "attr"]
    - [BareValue, "value"]
    - ElementEnd
    - ElementStart
    - [Name, "b"]
    - ElementEnd

- id: prose_then_element_at_same_level
  desc: Prose then element at same column (both children of parent)
  udon: |-
    |parent
      some prose
      |child
  events:
    # |parent at column 0
    # "some prose" at column 2 - child of parent (prose content)
    # |child at column 2 - also child of parent (sibling of prose conceptually)
    - ElementStart
    - [Name, "parent"]
    - [Text, "some prose"]
    - ElementStart
    - [Name, "child"]
    - ElementEnd
    - ElementEnd

- id: element_at_column_zero_after_deep_nesting
  desc: Element at column 0 closes all deeply nested elements
  udon: |-
    |a
     |b
      |c
       |d
        |e
         |f
    |z
  events:
    # Each element nests one column deeper
    # |z at column 0 closes all (a through f) and is sibling of |a
    - ElementStart
    - [Name, "a"]
    - ElementStart
    - [Name, "b"]
    - ElementStart
    - [Name, "c"]
    - ElementStart
    - [Name, "d"]
    - ElementStart
    - [Name, "e"]
    - ElementStart
    - [Name, "f"]
    - ElementEnd
    - ElementEnd
    - ElementEnd
    - ElementEnd
    - ElementEnd
    - ElementEnd
    - ElementStart
    - [Name, "z"]
    - ElementEnd

# Regression tests for content_base preservation after child element returns
# Bug: After child element closed due to dedent, parent's content_base was not
# being used correctly - prose at the same column as previous prose would
# incorrectly trigger an "inconsistent indentation" warning.

- id: prose_after_child_element_at_same_column
  desc: Prose after child element at same column as prior prose (no warning)
  udon: |-
    |p
      first prose
      |em child
      second prose
  events:
    # |p at column 0
    # "first prose" at column 2 - sets content_base = 2
    # |em at column 2 - child element
    # "second prose" at column 2 - matches content_base, NO warning
    - ElementStart
    - [Name, "p"]
    - [Text, "first prose"]
    - ElementStart
    - [Name, "em"]
    - [Text, "child"]
    - ElementEnd
    - [Text, "second prose"]
    - ElementEnd

- id: prose_after_child_element_less_indent_warns
  desc: Prose after child element with less indent than content_base (warns)
  udon: |-
    |p
      first prose
      |em child
     second prose
  events:
    # |p at column 0
    # "first prose" at column 2 - sets content_base = 2
    # |em at column 2 - child element
    # "second prose" at column 1 - less than content_base, WARNING
    - ElementStart
    - [Name, "p"]
    - [Text, "first prose"]
    - ElementStart
    - [Name, "em"]
    - [Text, "child"]
    - ElementEnd
    - [Warning, "Inconsistent indentation"]
    - [Text, "second prose"]
    - ElementEnd

- id: sameline_content_then_child_then_prose
  desc: Sameline content then child then prose (no warning)
  udon: |-
    |p sameline
       |em child
       after child
  events:
    # |p with sameline content - content_base not set for block children
    # |em at column 3 - child element
    # "after child" at column 3 - sets content_base = 3, no warning
    - ElementStart
    - [Name, "p"]
    - [Text, "sameline"]
    - ElementStart
    - [Name, "em"]
    - [Text, "child"]
    - ElementEnd
    - [Text, "after child"]
    - ElementEnd

- id: sameline_content_then_child_then_inconsistent_prose
  desc: Sameline content then child then prose at different columns (warns on decrease)
  udon: |-
    |p sameline
       |em child
       first
      second
  events:
    # |p with sameline content
    # |em at column 3 - child element
    # "first" at column 3 - sets content_base = 3
    # "second" at column 2 - less than content_base, WARNING
    - ElementStart
    - [Name, "p"]
    - [Text, "sameline"]
    - ElementStart
    - [Name, "em"]
    - [Text, "child"]
    - ElementEnd
    - [Text, "first"]
    - [Warning, "Inconsistent indentation"]
    - [Text, "second"]
    - ElementEnd

# =============================================================================
# content_base applies to ALL child content (elements, attributes, etc.)
# SPEC lines 820-960: content_base tracks first child content's column
# =============================================================================

- id: decreasing_element_indent_warns
  desc: Elements at decreasing indent levels trigger warnings
  udon: |-
    |alpha
        |a
       |b
      |c
     |d
  events:
    # |alpha at col 0
    # |a at col 4 - first child, sets content_base = 4
    # |b at col 3 < 4, WARNING, content_base = 3
    # |c at col 2 < 3, WARNING, content_base = 2
    # |d at col 1 < 2, WARNING, content_base = 1
    - ElementStart
    - [Name, "alpha"]
    - ElementStart
    - [Name, "a"]
    - ElementEnd
    - [Warning, "Inconsistent indentation"]
    - ElementStart
    - [Name, "b"]
    - ElementEnd
    - [Warning, "Inconsistent indentation"]
    - ElementStart
    - [Name, "c"]
    - ElementEnd
    - [Warning, "Inconsistent indentation"]
    - ElementStart
    - [Name, "d"]
    - ElementEnd
    - ElementEnd

- id: element_then_prose_inconsistent_warns
  desc: Element sets content_base, prose at less indent warns
  udon: |-
    |p
        |em child
      prose here
  events:
    # |em at col 4 sets content_base = 4
    # prose at col 2 < 4, WARNING
    - ElementStart
    - [Name, "p"]
    - ElementStart
    - [Name, "em"]
    - [Text, "child"]
    - ElementEnd
    - [Warning, "Inconsistent indentation"]
    - [Text, "prose here"]
    - ElementEnd

- id: attribute_sets_content_base
  desc: Block attribute sets content_base, subsequent less indent warns
  udon: |-
    |el
        :attr value
      prose
  events:
    # :attr at col 4 sets content_base = 4
    # prose at col 2 < 4, WARNING
    - ElementStart
    - [Name, "el"]
    - [Attr, "attr"]
    - [BareValue, "value"]
    - [Warning, "Inconsistent indentation"]
    - [Text, "prose"]
    - ElementEnd

- id: comment_sets_content_base
  desc: Block comment sets content_base, subsequent less indent warns
  udon: |-
    |el
        ; a comment
      prose
  events:
    # ; comment at col 4 sets content_base = 4
    # prose at col 2 < 4, WARNING
    - ElementStart
    - [Name, "el"]
    - CommentStart
    - [Text, " a comment"]
    - CommentEnd
    - [Warning, "Inconsistent indentation"]
    - [Text, "prose"]
    - ElementEnd

- id: mixed_content_types_consistent
  desc: Elements, attributes, prose at same column - no warnings
  udon: |-
    |el
      :attr value
      |child
      prose text
      ; comment
      more prose
  events:
    # All at col 2, no warnings
    - ElementStart
    - [Name, "el"]
    - [Attr, "attr"]
    - [BareValue, "value"]
    - ElementStart
    - [Name, "child"]
    - ElementEnd
    - [Text, "prose text"]
    - CommentStart
    - [Text, " comment"]
    - CommentEnd
    - [Text, "more prose"]
    - ElementEnd

# =============================================================================
# Whitespace-only lines should NOT affect content_base
# SPEC line 1664: "Blank lines passed through"
# A line with only spaces should be equivalent to a blank line
# =============================================================================

- id: blank_line_preserved_in_prose
  desc: Blank line in prose preserved as BlankLine event
  udon: |-
    |p
      first

      second
  events:
    # Blank line between first and second - preserved as BlankLine
    - ElementStart
    - [Name, "p"]
    - [Text, "first"]
    - BlankLine
    - [Text, "second"]
    - ElementEnd

- id: blank_line_between_elements
  desc: Blank line between child elements - emits BlankLine
  udon: |-
    |p
      |a

      |b
  events:
    # Blank line is encountered while inside |a (before dedent closes it)
    # So BlankLine is a child of |a, emitted before |a's ElementEnd
    - ElementStart
    - [Name, "p"]
    - ElementStart
    - [Name, "a"]
    - BlankLine
    - ElementEnd
    - ElementStart
    - [Name, "b"]
    - ElementEnd
    - ElementEnd

# NOTE: Whitespace-only lines (lines with spaces but no content):
# - Treated identically to blank lines (emit BlankLine)
# - Do NOT trigger indentation warnings
# - Do NOT affect content_base
# - Cannot be tested via YAML fixtures (YAML strips trailing whitespace)
# - Must be tested programmatically in a separate test

# =============================================================================
# Complex interleaving of elements and prose
# =============================================================================

- id: deep_nesting_with_prose_at_each_level
  desc: Prose at multiple nesting levels, each consistent
  udon: |-
    |div
      div text
      |p
        p text
        |em
          em text
        after em
      after p
    after div
  events:
    - ElementStart
    - [Name, "div"]
    - [Text, "div text"]
    - ElementStart
    - [Name, "p"]
    - [Text, "p text"]
    - ElementStart
    - [Name, "em"]
    - [Text, "em text"]
    - ElementEnd
    - [Text, "after em"]
    - ElementEnd
    - [Text, "after p"]
    - ElementEnd
    - [Text, "after div"]

- id: multiple_children_then_prose
  desc: Multiple child elements then prose at same column
  udon: |-
    |p
      |a first
      |b second
      |c third
      prose after all
  events:
    - ElementStart
    - [Name, "p"]
    - ElementStart
    - [Name, "a"]
    - [Text, "first"]
    - ElementEnd
    - ElementStart
    - [Name, "b"]
    - [Text, "second"]
    - ElementEnd
    - ElementStart
    - [Name, "c"]
    - [Text, "third"]
    - ElementEnd
    - [Text, "prose after all"]
    - ElementEnd

- id: prose_element_prose_element_prose
  desc: Alternating prose and elements at same column
  udon: |-
    |p
      prose 1
      |em em1
      prose 2
      |strong strong1
      prose 3
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "prose 1"]
    - ElementStart
    - [Name, "em"]
    - [Text, "em1"]
    - ElementEnd
    - [Text, "prose 2"]
    - ElementStart
    - [Name, "strong"]
    - [Text, "strong1"]
    - ElementEnd
    - [Text, "prose 3"]
    - ElementEnd

# =============================================================================
# Escaped prefixes after child elements
# =============================================================================

- id: escaped_pipe_after_child
  desc: Escaped pipe after child element is prose
  udon: |-
    |p
      first
      |em child
      '|not element
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "first"]
    - ElementStart
    - [Name, "em"]
    - [Text, "child"]
    - ElementEnd
    - [Text, "|not element"]
    - ElementEnd

- id: escaped_colon_after_child
  desc: Escaped colon after child element is prose
  udon: |-
    |p
      first
      |em child
      ':not attr
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "first"]
    - ElementStart
    - [Name, "em"]
    - [Text, "child"]
    - ElementEnd
    - [Text, ":not attr"]
    - ElementEnd
