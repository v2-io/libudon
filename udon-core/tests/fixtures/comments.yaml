# Comment and text tests
# Tests from old parsing.rs comments_and_text module
# Audited against FULL-SPEC.md
#
# NOTE: Comment is now a BRACKET type (like Element), so comments emit:
#   CommentStart -> Text (content) -> CommentEnd
# This allows comment continuation to use the same "children loop" pattern
# as Element and Directive, DRYing the indentation-based block handling.

# ===========================================================================
# Empty/Blank Input (baseline)
# ===========================================================================

- id: empty_input
  desc: Empty input produces no events
  udon: ""
  events: []

- id: blank_lines
  desc: Blank lines produce no events
  udon: "\n\n\n"
  events: []

# ===========================================================================
# Line Comments at Document Root
# SPEC lines 401-407: Document root - `;` starts line comment
# ===========================================================================

- id: single_comment
  desc: Single line comment at document root
  # SPEC line 407: Document root -> Line comment
  udon: "; this is a comment\n"
  events:
    - CommentStart
    - [Text, " this is a comment"]
    - CommentEnd

- id: multiple_comments
  desc: Multiple consecutive comments
  udon: "; first\n; second\n; third\n"
  events:
    - CommentStart
    - [Text, " first"]
    - CommentEnd
    - CommentStart
    - [Text, " second"]
    - CommentEnd
    - CommentStart
    - [Text, " third"]
    - CommentEnd

- id: comment_no_space
  desc: Comment without space after semicolon
  udon: ";no space\n"
  events:
    - CommentStart
    - [Text, "no space"]
    - CommentEnd

- id: comment_empty
  desc: Empty comment (just semicolon)
  udon: ";\n"
  events:
    - CommentStart
    - [Text, ""]
    - CommentEnd

- id: comment_no_trailing_newline
  desc: Comment at EOF without trailing newline
  # EOF is a valid terminator for comments - no error expected
  udon: "; comment"
  events:
    - CommentStart
    - [Text, " comment"]
    - CommentEnd

# ===========================================================================
# Text (Prose) at Document Root
# SPEC lines 401-407: Document root - `;` starts line comment
# ===========================================================================

- id: simple_text
  desc: Simple text line at document root
  udon: "Hello world\n"
  events:
    - [Text, "Hello world"]

- id: text_with_semicolon_literal
  desc: Prose text with semicolon is literal (not comment)
  # `;` mid-line in prose is LITERAL - only `;` at line start or in sameline context triggers comment
  # `;{...}` inline form works anywhere for comments within prose
  udon: "Some text ; not a comment\n"
  events:
    - [Text, "Some text ; not a comment"]

- id: mixed_content
  desc: Comments and text interspersed at document root
  udon: "; Comment\nText line\n; Another comment\n"
  events:
    - CommentStart
    - [Text, " Comment"]
    - CommentEnd
    - [Text, "Text line"]
    - CommentStart
    - [Text, " Another comment"]
    - CommentEnd

- id: text_no_trailing_newline
  desc: Text at EOF without trailing newline
  udon: "Hello"
  events:
    - [Text, "Hello"]

# ===========================================================================
# Comments in Sameline Context
# SPEC lines 409-411: Sameline prose/attrs - `;` starts line comment
# ===========================================================================

- id: element_with_inline_comment
  desc: Element with inline comment after sameline content
  # SPEC line 409: Sameline prose -> Line comment
  udon: "|p Hello ; comment\n"
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "Hello "]
    - CommentStart
    - [Text, " comment"]
    - CommentEnd
    - ElementEnd

- id: element_only_comment
  desc: Element followed only by comment (no content)
  # SPEC line 411: Sameline attrs -> Line comment (after values)
  udon: "|div ; just a comment\n"
  events:
    - ElementStart
    - [Name, "div"]
    - CommentStart
    - [Text, " just a comment"]
    - CommentEnd
    - ElementEnd

- id: element_attrs_then_comment
  desc: Element with sameline attrs then comment
  # SPEC line 411: Sameline attrs -> Line comment (after values)
  udon: "|el :key value ; trailing comment\n"
  events:
    - ElementStart
    - [Name, "el"]
    - [Attr, "key"]
    - [BareValue, "value"]
    - CommentStart
    - [Text, " trailing comment"]
    - CommentEnd
    - ElementEnd

# ===========================================================================
# Comments on Block Attribute Lines
# SPEC lines 280-291: Block attr values terminate at ` ;` (space+semicolon)
# SPEC line 410: Block attr line -> Line comment (after values)
# ===========================================================================

- id: comment_on_attr_line
  desc: Comment on indented block attribute line
  # SPEC lines 280-287: ` ;` terminates block attr value
  udon: "|el\n  :attr val ; comment\n"
  events:
    - ElementStart
    - [Name, "el"]
    - [Attr, "attr"]
    - [BareValue, "val"]
    - CommentStart
    - [Text, " comment"]
    - CommentEnd
    - ElementEnd

- id: attr_value_with_embedded_semicolon
  desc: Block attr value with semicolon (no space before) is part of value
  # SPEC lines 286-292: `;` without preceding space is part of value
  udon: "|el\n  :url https://example.com/path?q=1;s=2\n"
  events:
    - ElementStart
    - [Name, "el"]
    - [Attr, "url"]
    - [BareValue, "https://example.com/path?q=1;s=2"]
    - ElementEnd

- id: attr_value_semicolon_then_comment
  desc: Block attr value with embedded semicolon then space-semicolon comment
  # SPEC lines 283-284: semicolon with space before starts comment
  udon: "|el\n  :data foo;bar ; this is comment\n"
  events:
    - ElementStart
    - [Name, "el"]
    - [Attr, "data"]
    - [BareValue, "foo;bar"]
    - CommentStart
    - [Text, " this is comment"]
    - CommentEnd
    - ElementEnd

# ===========================================================================
# Block Prose - Semicolons are LITERAL
# SPEC line 408: Block prose -> **Literal** (not comment)
# SPEC lines 429-448: Block prose preserves literal content including semicolons
# ===========================================================================

- id: block_prose_literal_semicolon
  desc: Block prose preserves semicolons as literal content
  # SPEC line 408: Block prose -> **Literal** (not comment)
  # SPEC lines 429-448: Block prose sets indent-column, preserves literal semicolons
  udon: "|pre\n  code; more code\n"
  events:
    - ElementStart
    - [Name, "pre"]
    - [Text, "code; more code"]
    - ElementEnd

- id: block_prose_multiple_semicolons
  desc: Block prose with multiple semicolons
  # SPEC line 408: All semicolons in block prose are literal
  udon: "|code\n  a; b; c;\n"
  events:
    - ElementStart
    - [Name, "code"]
    - [Text, "a; b; c;"]
    - ElementEnd

- id: block_prose_semicolon_at_start
  desc: Line starting with semicolon inside element is a comment
  # SPEC lines 459-466: "A line starting with `;` is a block comment"
  # NOTE: SPEC 408 "block prose semicolons literal" means ; WITHIN text, not at line start
  # A line starting with ; (after indent) is ALWAYS a block comment
  udon: "|pre\n  ; this IS a comment inside the element\n"
  events:
    - ElementStart
    - [Name, "pre"]
    - CommentStart
    - [Text, " this IS a comment inside the element"]
    - CommentEnd
    - ElementEnd

# ===========================================================================
# Brace Comments (Inline Comments)
# SPEC lines 449-458, 489-498: `;{...}` inline comments with brace-counting
# SPEC line 412: Inline/embedded -> `;{...}` only
# ===========================================================================

- id: brace_comment_in_sameline
  desc: Brace comment in sameline prose
  # SPEC lines 449-458, 489-498: `;{...}` inline comment
  udon: "|p Text ;{TODO: fix} more text\n"
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "Text "]
    - CommentStart
    - [Text, "TODO: fix"]
    - CommentEnd
    - [Text, " more text"]
    - ElementEnd

- id: brace_comment_empty
  desc: Empty brace comment
  udon: "|p Before ;{} after\n"
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "Before "]
    - CommentStart
    - [Text, ""]
    - CommentEnd
    - [Text, " after"]
    - ElementEnd

- id: brace_comment_nested_braces
  desc: Brace comment with nested balanced braces
  # SPEC lines 455-457: Nested `{}` pairs allowed if balanced
  udon: "|p Text ;{comment with {nested} braces} more\n"
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "Text "]
    - CommentStart
    - [Text, "comment with {nested} braces"]
    - CommentEnd
    - [Text, " more"]
    - ElementEnd

- id: brace_comment_deeply_nested
  desc: Brace comment with deeply nested braces
  # SPEC lines 455-457: Brace-counting for nested pairs
  udon: "|p Text ;{outer {middle {inner}} end} rest\n"
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "Text "]
    - CommentStart
    - [Text, "outer {middle {inner}} end"]
    - CommentEnd
    - [Text, " rest"]
    - ElementEnd

- id: brace_comment_in_embedded
  desc: Brace comment inside embedded element
  # SPEC line 412: Inline/embedded -> `;{...}` only
  udon: "|p Click |{a here ;{note} link}\n"
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "Click "]
    - EmbeddedStart
    - [Name, "a"]
    - [Text, "here "]
    - CommentStart
    - [Text, "note"]
    - CommentEnd
    - [Text, " link"]
    - EmbeddedEnd
    - ElementEnd

- id: brace_comment_at_document_root
  desc: Brace comment at document root (after text)
  udon: "Text ;{comment} more\n"
  events:
    - [Text, "Text "]
    - CommentStart
    - [Text, "comment"]
    - CommentEnd
    - [Text, " more"]

- id: brace_comment_at_line_start
  desc: Brace comment at line start (document root)
  # At line start, ;{ is brace comment, not line comment
  udon: ";{brace comment}\n"
  events:
    - CommentStart
    - [Text, "brace comment"]
    - CommentEnd

# ===========================================================================
# Escaped Semicolons
# SPEC lines 503-508: `';` at line start outputs literal `;`
# SPEC lines 512-530: Backslash escapes in sameline/embedded contexts
# ===========================================================================

- id: escaped_semicolon_line_start
  desc: Escaped semicolon at line start outputs literal
  # SPEC lines 503-508: `';` -> `;` literal
  # SPEC lines 104-124: Block-level escape
  udon: "'; This starts with semicolon\n"
  events:
    - [Text, "; This starts with semicolon"]

- id: escaped_semicolon_in_element
  desc: Escaped semicolon at block line start in element
  # SPEC lines 503-508: Escape applies at line start (after indent)
  udon: "|div\n  '; semicolon line\n"
  events:
    - ElementStart
    - [Name, "div"]
    - [Text, "; semicolon line"]
    - ElementEnd

- id: backslash_semicolon_sameline
  desc: Backslash escapes semicolon in sameline context
  # SPEC lines 512-530: Backslash escapes in sameline contexts
  udon: "|el :key val\\;ue ; real comment\n"
  events:
    - ElementStart
    - [Name, "el"]
    - [Attr, "key"]
    - [BareValue, "val\\;ue"]
    - CommentStart
    - [Text, " real comment"]
    - CommentEnd
    - ElementEnd

# ===========================================================================
# Comment Continuation with Indentation
# SPEC lines 419-428: Line comment followed by indented continuation
# With BRACKET model, continuation lines are separate Text events
# ===========================================================================

- id: comment_continuation
  desc: Line comment with indented continuation
  # SPEC lines 419-428: More-indented lines after comment are comment content
  # With BRACKET model: each line is a separate Text event inside CommentStart/End
  # First continuation line sets content_base; lines at content_base have no indent
  udon: "; This is a comment\n  this is still part of the comment\n"
  events:
    - CommentStart
    - [Text, " This is a comment"]
    - [Text, "this is still part of the comment"]
    - CommentEnd

- id: comment_continuation_multiple_lines
  desc: Line comment with multiple continuation lines
  # SPEC lines 419-428: Continuation until dedent
  # All continuations at content_base (col 2), so no indent in output
  udon: "; Main comment\n  continuation 1\n  continuation 2\n"
  events:
    - CommentStart
    - [Text, " Main comment"]
    - [Text, "continuation 1"]
    - [Text, "continuation 2"]
    - CommentEnd

- id: comment_continuation_ends_at_dedent
  desc: Comment continuation ends when dedent occurs
  # SPEC lines 419-428: Comment content until dedent
  # Continuation at content_base, so no indent in output
  udon: "; Comment\n  continued\nNot comment\n"
  events:
    - CommentStart
    - [Text, " Comment"]
    - [Text, "continued"]
    - CommentEnd
    - [Text, "Not comment"]

- id: comment_continuation_extra_indent
  desc: Comment continuation preserves extra indent beyond content_base
  # First continuation (col 2) sets content_base=2
  # Second continuation (col 4) has 2 extra spaces of indent
  # Third continuation (col 6) has 4 extra spaces of indent
  # Fourth continuation (col 2) back at content_base
  udon: "; line one\n  line two\n    line three\n      line four\n  line five\n"
  events:
    - CommentStart
    - [Text, " line one"]
    - [Text, "line two"]
    - [Text, "  line three"]
    - [Text, "    line four"]
    - [Text, "line five"]
    - CommentEnd

- id: comment_continuation_inconsistent_indent
  desc: Comment continuation with inconsistent (decreased) indent warns
  # Like prose, inconsistent indent triggers warning and resets content_base
  # First cont (col 4) sets content_base=4
  # Second cont (col 2) < content_base, triggers warning, resets to 2
  # Third cont (col 2) at new content_base, no warning
  udon: "; comment\n    first cont\n  less indent\n  at new base\n"
  events:
    - CommentStart
    - [Text, " comment"]
    - [Text, "first cont"]
    - [Warning, "Inconsistent indentation"]
    - [Text, "less indent"]
    - [Text, "at new base"]
    - CommentEnd

# ===========================================================================
# Comments Affecting Hierarchy (Indent/Dedent)
# SPEC lines 459-487: Block comments trigger indent/dedent behavior
# ===========================================================================

- id: comment_as_sibling
  desc: Comment at same indent as element becomes sibling
  # SPEC lines 465-477: Comment at same column as previous = sibling
  udon: "|parent\n  |child\n  ; sibling comment\n"
  events:
    - ElementStart
    - [Name, "parent"]
    - ElementStart
    - [Name, "child"]
    - ElementEnd
    - CommentStart
    - [Text, " sibling comment"]
    - CommentEnd
    - ElementEnd

- id: comment_inside_element
  desc: Comment at greater indent is inside element
  # SPEC lines 469-471: Comment further right is inside element
  udon: "|parent\n  |child\n   ; inside child\n"
  events:
    - ElementStart
    - [Name, "parent"]
    - ElementStart
    - [Name, "child"]
    - CommentStart
    - [Text, " inside child"]
    - CommentEnd
    - ElementEnd
    - ElementEnd

- id: comment_closes_elements
  desc: Comment at column 0 closes nested elements
  # SPEC lines 475-480: Column 0 comment causes ElementEnd events
  udon: "|one\n  |two\n    |three\n; closes all\n"
  events:
    - ElementStart
    - [Name, "one"]
    - ElementStart
    - [Name, "two"]
    - ElementStart
    - [Name, "three"]
    - ElementEnd
    - ElementEnd
    - ElementEnd
    - CommentStart
    - [Text, " closes all"]
    - CommentEnd

- id: comment_between_siblings
  desc: Comment between sibling elements
  udon: "|parent\n  |child1\n  ; between\n  |child2\n"
  events:
    - ElementStart
    - [Name, "parent"]
    - ElementStart
    - [Name, "child1"]
    - ElementEnd
    - CommentStart
    - [Text, " between"]
    - CommentEnd
    - ElementStart
    - [Name, "child2"]
    - ElementEnd
    - ElementEnd

# ===========================================================================
# Edge Cases
# ===========================================================================

- id: semicolon_in_quoted_string
  desc: Semicolon in quoted attribute value is literal
  # Quoted strings handle their own escaping
  udon: "|el :msg \"hello; world\"\n"
  events:
    - ElementStart
    - [Name, "el"]
    - [Attr, "msg"]
    - [StringValue, "hello; world"]
    - ElementEnd

- id: multiple_brace_comments
  desc: Multiple brace comments on same line
  udon: "|p A ;{one} B ;{two} C\n"
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "A "]
    - CommentStart
    - [Text, "one"]
    - CommentEnd
    - [Text, " B "]
    - CommentStart
    - [Text, "two"]
    - CommentEnd
    - [Text, " C"]
    - ElementEnd

- id: line_comment_after_brace_comment
  desc: Line comment after brace comment on sameline
  udon: "|p Text ;{inline} more ; line comment\n"
  events:
    - ElementStart
    - [Name, "p"]
    - [Text, "Text "]
    - CommentStart
    - [Text, "inline"]
    - CommentEnd
    - [Text, " more "]
    - CommentStart
    - [Text, " line comment"]
    - CommentEnd
    - ElementEnd
