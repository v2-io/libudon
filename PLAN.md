# descent Integration Plan

Parser generator rewrite using descent (~/src/descent/).

## Guiding Principle

descent **replaces** libudon's parser infrastructure entirely. The old ring-buffer,
ChunkSlice, ChunkArena, 24-variant StreamingEvent architecture is gone. descent
generates clean callback-based recursive descent parsers that are 2-7x faster.

## Status

**Branch:** `phase-3-genmachine-rewrite`

**Current work:** Parser generates and compiles! Basic parsing works.

## Phase 1: Development Workflow (DONE)

- [x] `dx gem install` in descent works
- [x] `descent` CLI accessible from libudon

## Phase 2: Clean Slate (DONE)

- [x] Deleted `parser.rs` (307KB generated garbage)
- [x] Deleted `streaming.rs` (ChunkArena, ChunkSlice, EventRing, StreamingEvent)
- [x] Updated lib.rs to use descent-generated parser
- [x] Old tests reference deleted infrastructure (need rewrite)

## Phase 3: Build Forward (IN PROGRESS)

- [x] Get udon.desc generating valid Rust
  - Fixed: Removed explicit EXPECTS (now inferred)
  - Fixed: Removed error function stub (use built-in /error)
  - Fixed: Added missing |default cases
  - Fixed: BoolTrue/BoolFalse/Nil with literals for content
  - Fixed: Escape sequences (<R>, <RB>, <P>, <L>) in character classes
- [x] Basic parsing works (elements, attributes, text, nesting)
- [x] Created `regenerate-parser` script (concatenates .desc files, runs descent)
- [x] Integrated values.desc into main parser via concatenation
- [ ] **Nomenclature refactor** - see ~/src/udon/SPEC-UPDATE.md
  - Rename `inline_*` â†’ `sameline_*` for element-line contexts
  - Fix value terminators by context (block/sameline/embedded/array)
  - Clarify comment behavior (`;` literal in block prose, comment in sameline)
- [ ] New testing infrastructure against descent's event model
- [ ] Complete directive parsing in udon.desc (currently stubs)

## udon.desc Implementation Checklist

From SPEC.md, ensure these are implemented correctly:

### Core Syntax
- [ ] Inline escape mid-line (`'|` in prose escapes the pipe)
- [ ] Pipe-as-text (` | ` in prose is text, not element)
- [ ] Arbitrary brace depth (use counter or recursion, not hardcoded states)

### Span Accuracy
- [ ] Correct spans for suffix/ID/class attributes (MARK at right position)

### Testing Philosophy
- Tests MUST be derived from SPEC.md, not from implementation
- Tests should cover edge cases: mid-line, mid-content, deeply nested, boundary conditions
- Use property-based testing where applicable
- All features should work at any column, not just column 0

## Phase 4: Performance & Streaming

- [ ] Comprehensive benchmarks (criterion)
- [ ] Multi-chunk streaming support (in descent)
- [ ] Backpressure handling (solved by multi-chunk)

## Phase 5: Language Bindings

- [ ] Update ~/src/udon-ruby to use new SAX/streaming API
- [ ] FFI layer (thin wrapper around callback API)
- [ ] WASM target

## Phase 6: Higher-Level APIs

- [ ] Full parse + lazy AST (built on event stream)

## Key Files

| File | Purpose |
|------|---------|
| `generator/udon.desc` | Main parser grammar |
| `generator/values.desc` | Value type parsing (concatenated with udon.desc) |
| `udon-core/src/parser.rs` | GENERATED by descent |
| `udon-core/src/value.rs` | Post-hoc value classification (may be replaced) |
| `regenerate-parser` | Script to regenerate parser from .desc files |

## descent Workflow

```bash
# Install descent locally (from ~/src/descent/)
dx gem install

# Regenerate parser (concatenates udon.desc + values.desc, runs descent, builds)
./regenerate-parser

# Generate only (no build)
./regenerate-parser --no-build

# Check descent availability
./regenerate-parser --check

# Debug parsing stages (on individual .desc files)
descent debug generator/udon.desc
descent debug generator/udon.desc --tokens
```

## Reference

- ~/src/descent/CLAUDE.md - descent usage guide
- ~/src/udon/SPEC.md - Authoritative UDON specification
