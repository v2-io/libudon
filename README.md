# libudon

High-performance UDON parser in Rust.

## What is UDON?

UDON (Universal Document & Object Notation) is a unified notation for documents, data, and configuration. See the [specification](https://github.com/josephwecker/udon) for details.

## Status

**Phase 3 complete** - Parser rewritten using [descent](https://github.com/josephwecker/descent), a parser generator that produces callback-based recursive descent parsers.

### Features

| Feature | Syntax | Status |
|---------|--------|--------|
| Elements | `\|element[id].class1.class2?` | ✅ |
| Attributes | `:key value` | ✅ |
| Typed values | integers, floats, rationals, complex, booleans, nil, strings | ✅ |
| Arrays | `[1 2 3]` | ✅ |
| Text/prose | indented content | ✅ |
| Hierarchy | indentation and rightward nesting | ✅ |
| Comments | `; line` and `;{inline}` | ✅ |
| Embedded elements | `\|{em bold text}` | ✅ |
| Interpolation | `!{{expression}}` | ✅ |
| Block directives | `!if condition` | ✅ |
| Inline directives | `!{include partial}` | ✅ |
| Raw blocks | `!:lang:` | ✅ |
| References | `@[name]` | ✅ |
| Freeform blocks | ` ``` ` | ✅ |

### Performance

Benchmarked on Apple Silicon (M-series):

| Benchmark | Throughput |
|-----------|------------|
| Comments | **1.07 GiB/s** |
| Minimal file | **847 MiB/s** |
| Comprehensive (15KB) | **820 MiB/s** |
| Text content | **779 MiB/s** |
| Dynamic content | **672 MiB/s** |
| Nested elements | **511 MiB/s** |

#### Comparison with Previous Parser

| Benchmark | Old (streaming) | New (descent) | Speedup |
|-----------|-----------------|---------------|---------|
| comprehensive.udon | 496 MiB/s | **820 MiB/s** | **1.65x** |
| minimal.udon | 472 MiB/s | **847 MiB/s** | **1.79x** |
| comments_only | 278 MiB/s | **1,070 MiB/s** | **3.85x** |
| text_only | 317 MiB/s | **779 MiB/s** | **2.46x** |
| empty (overhead) | 82 ns | **1.3 ns** | **63x less** |

## Structure

```
libudon/
├── udon-core/           # Core parser library
│   └── src/
│       ├── lib.rs       # Public API
│       ├── parser.rs    # GENERATED by descent
│       └── span.rs      # Source locations
├── generator/           # Parser specification
│   ├── udon.desc        # Main parser grammar
│   └── values.desc      # Value type parsing
└── regenerate-parser    # Script to regenerate parser
```

## Building

```bash
cargo build --release
```

## Testing

```bash
cargo test
```

## Benchmarking

```bash
cargo bench --bench parse
```

## Regenerating the Parser

The parser is generated from `.desc` specifications using descent:

```bash
# Install descent (from ~/src/descent/)
cd ~/src/descent && dx gem install

# Regenerate parser
./regenerate-parser

# Regenerate with tracing (for debugging)
./regenerate-parser --trace
```

## Usage (Rust)

```rust
use udon_core::Parser;

let input = b"|article[intro]\n  :author Joseph\n  Hello, world!\n";

Parser::new(input).parse(|event| {
    println!("{}", event.format_line());
});
```

Output:
```
ElementStart @ 1..1
Name "article" @ 1..8
Attr "id" @ 8..15
BareValue "intro" @ 9..14
Attr "author" @ 19..25
BareValue "Joseph" @ 27..33
Text "Hello, world!" @ 36..49
ElementEnd @ 50..50
```

## Related Repositories

- [udon](https://github.com/josephwecker/udon) - Specification and examples
- [descent](https://github.com/josephwecker/descent) - Parser generator
- [udon-ruby](https://github.com/josephwecker/udon-ruby) - Ruby gem (needs update)

## License

MIT
